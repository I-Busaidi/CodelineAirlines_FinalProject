@page "/AirportManagement"
@layout Layout.AdminLayout
@inject IAirportService airportService
@inject NavigationManager NavigationManager
@using MudBlazor

@attribute [Authorize(Roles = "admin")]

<MudContainer Class="airport-management-container">
    <!-- Page Title -->
    <MudText Typo="Typo.h4" Class="page-title mb-6">Airport Management</MudText>

    <!-- Search Bar -->
    <MudGrid>
        <MudItem xs="12">
            <div style="display: flex; align-items: center; gap: 8px;">
                <MudTextField Label="Search Airports"
                              @bind-Value="searchQuery"
                              Adornment="Adornment.Start"
                              Icon="@Icons.Material.Filled.Search"
                              FullWidth="true"
                              Placeholder="Enter airport name, code, city, or country..."
                              OnKeyUp="HandleSearchKeyUp" />
                <MudIconButton Icon="@Icons.Material.Filled.Search"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="OnSearchClicked" />
            </div>
        </MudItem>
    </MudGrid>

    <!-- Airport Expansion Panels (filtered by search query) -->
    <MudExpansionPanels Class="mt-4">
        @if (filteredAirports.Any())
        {
            @foreach (var airport in filteredAirports)
            {
                <MudExpansionPanel Text="@($"{airport.AirportName} ({airport.AirportId})")" Icon="@Icons.Material.Filled.AirplanemodeActive" Class="mb-4">
                    <MudCard Class="airport-card">
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.body1"><strong>Airport Name:</strong> @airport.AirportName</MudText>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.body1"><strong>Code:</strong> @airport.AirportId</MudText>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.body1"><strong>Location:</strong> @airport.City</MudText>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.body1"><strong>Country:</strong> @airport.Country</MudText>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="@(() => DeleteAirport(airport))" StartIcon="@Icons.Material.Filled.Delete">
                                Delete
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudExpansionPanel>
            }
        }
        else
        {
            <MudText Typo="Typo.body2" Class="no-airports-text">No airports found matching your search.</MudText>
        }
    </MudExpansionPanels>

    <!-- Action Buttons (Add New Airport and Return) -->
    <MudGrid Class="mt-6" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="4" Class="mr-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNewAirport" FullWidth="true" StartIcon="@Icons.Material.Filled.Add" Class="action-button">
                Add New Airport
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ReturnToPreviousPage" FullWidth="true" StartIcon="@Icons.Material.Filled.ArrowBack" Class="action-button">
                Return
            </MudButton>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string searchQuery = string.Empty;
    private List<AirportOutputDTO> airports = new List<AirportOutputDTO>();
    private List<AirportOutputDTO> filteredAirports = new List<AirportOutputDTO>();

    // Trigger search when search button is clicked
    private void OnSearchClicked()
    {
        FilterAirports();
    }

    // Handle Enter key press to trigger search
    private void HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            FilterAirports();
        }
    }

    // Filter airports based on the search query
    private void FilterAirports()
    {
        if (!string.IsNullOrEmpty(searchQuery))
        {
            filteredAirports = airports.Where(a => a.AirportName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                                                  a.AirportId.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                                                  a.City.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                                                  a.Country.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        else
        {
            filteredAirports = airports; // Show all airports if search query is empty
        }
    }

    // Example method to delete an airport
    private void DeleteAirport(AirportOutputDTO airport)
    {
        try
        {
            airportService.DeleteAirport(airport.AirportId); // Call the service to delete the airport by its code
            airports.Remove(airport); // Remove the airport from the list
            FilterAirports(); // Update the filtered list
        }
        catch (Exception ex)
        {
            Log.Error($"Error deleting airport: {ex.Message}");
        }
    }

    // Navigate to the Add New Airport page
    private void AddNewAirport()
    {
        NavigationManager.NavigateTo("/AddAirport"); // Replace with the route to your Add Airport page
    }

    // Return to the previous page
    private void ReturnToPreviousPage()
    {
        NavigationManager.NavigateTo("/AdminHomePage"); // Navigate to the home page or previous page
    }

    // Load airports when the page is initialized
    protected override void OnInitialized()
    {
        airports = airportService.GetAllAirports(); // Fetch the list of airports from the service
        filteredAirports = airports; // Show all airports initially
    }
}

<style>
    /* Container Styling */
    .airport-management-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Page Title Styling */
    .page-title {
        font-weight: 700;
        color: #2c3e50;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    /* Search Button Styling */
    .search-button {
        font-weight: 600;
        padding: 12px;
        font-size: 16px;
        text-transform: uppercase;
        transition: background-color 0.3s ease;
        border-radius: 8px;
    }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

    /* Airport Card Styling */
    .airport-card {
        border-radius: 8px;
        background-color: #f8f9fa;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }

        .airport-card:hover {
            transform: scale(1.02);
        }

        .airport-card .mud-card-actions {
            display: flex;
            justify-content: flex-end;
        }

    /* No Airports Text Styling */
    .no-airports-text {
        color: #7f8c8d;
        font-style: italic;
    }

    /* Action Buttons Styling */
    .action-button {
        font-weight: 600;
        padding: 12px;
        font-size: 16px;
        text-transform: uppercase;
        transition: background-color 0.3s ease;
        border-radius: 8px;
    }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

    /* Spacing Utilities */
    .mb-6 {
        margin-bottom: 3rem !important;
    }

    .mt-4 {
        margin-top: 1.5rem !important;
    }

    .mt-6 {
        margin-top: 3rem !important;
    }
</style>